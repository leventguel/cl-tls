(defun gf128mul-spec (x y)
  (let ((res 0)
        (R #xE1000000000000000000000000000000)
        (mask #xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF))
    (dotimes (i 128)
      ;; Check if current bit in y is set (high to low)
      (when (logbitp (- 127 i) y)
	;; right shift
	(when (plusp (ldb (byte 1 1) x)) ;; Check if previous LSB was 1
	  (setf x (if (logbitp 0 x)
		      (logxor (ash x -1) R)
		      (ash x -1))))))
    (setf x (logand x mask))
    (setf res x)
    res))

(defun gf128mul-spec (x y)
  (let ((res 0)
        (R #xE1000000000000000000000000000000)
        (mask #xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF))
    (dotimes (i 128)
      (when (logbitp (- 127 i) y)
        (setf res (logxor (logand res mask) x)))
      (setf res (logand res mask)) ;; ✨ constrain res to 128 bits
      (setf x (if (logbitp 0 x)
                  (logand (logxor (ash x -1) R) mask)
                  (logand (ash x -1) mask)))
      (setf x (logand x mask)))
    res))


(defun test-gf128mul-spec1 ()
  (let* ((x #x00000000000000000000000000000001)
	 (y #x00000000000000000000000000000001)
	 (mask #xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF)
         (result (logand (gf128mul-spec x y) mask)))
    (format t "result   = ~{~2,'0X~}~%" (coerce (int->block result) 'list))))

(defun test-gf128mul-spec2 ()
  (let* ((x #xE1000000000000000000000000000000)
	(y #x00000000000000000000000000000001)
	(result (int->block (gf128mul-spec x y))))
    (format t "result   = ~{~2,'0X~}~%" (coerce result 'list))))

(defun gf128mul-ghash (H block)
  (let ((res 0)
        (R #xE1000000000000000000000000000000)
        (mask #xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF))
    (dotimes (i 128)
      (when (logbitp (- 127 i) block)
        (setf res (logxor (logand res mask) H)))
      (setf res (logand res mask)) ;; ✨ constrain res to 128 bits
      (setf H (if (logbitp 0 H)
                  (logand (logxor (ash H -1) R) mask)
                  (logand (ash H -1) mask)))
      (setf H (logand H mask)))
    res))

(defun test-gf128mul-ghash1 ()
  (let* ((H #x00000000000000000000000000000001)
	(block #x00000000000000000000000000000001)
	(result (gf128mul-spec H block)))
    (format t "~%Result   = ~32,'0X~%" result)
    (format t "Expected = 00000000000000000000000000000001~%")
    (int->block result)))

(defun test-gf128mul-ghash2 ()
  (let* ((H #xE1000000000000000000000000000000)
	(block #x00000000000000000000000000000001)
	 (result (gf128mul-spec H block)))
    
    (format t "~%Result   = ~32,'0X~%" result)
    (format t "Expected = E1000000000000000000000000000000~%")
    (int->block result)))

(defun test-gf128mul-ghash3 ()
    (let* ((H #xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF)
	   (block #x7a43ec1d9c0a5a78a0b16533a6213cab)
	   ;; multiply as GHASH expects
	   (result (gf128mul-spec H block)))
    
      (format t "~%Result   = ~32,'0X~%" result)
      (format t "Expected = D3E039B9DC59C2550B6636B9E0EBBA58~%")
      (int->block result)))

#|
(defun test-gf128mul-ghash3 ()
  (let* ((H-bytes (make-array 16 :element-type '(unsigned-byte 8) :initial-element #xFF))
         (block-bytes (make-array 16 :element-type '(unsigned-byte 8) :initial-element #xFF))
         (H (block->int H-bytes))  ;; assuming block->int is defined elsewhere
         (result (gf128mul-ghash H (block->int block-bytes))))
    (format t "~%Result   = ~32,'0X~%" result)
    (format t "Expected = D3E039B9DC59C2550B6636B9E0EBBA58~%")
    (int->block result)))
|#

;; Expected result #(13 161 137 173 254 164 254 28 53 30 192 60 41 80 131 192)
(defun test-gf128mul-ghash4 ()
  (let* ((H #x7CB681CD037B6D137A95F4DB99C48351)
	(block #x7A43EC1D9C0A5A78A0B16533A6213CAB)
	 (result (gf128mul-spec H block)))
    (format t "~%Result   = ~32,'0X~%" result)
    (format t "Expected = 0DA189ADFEA4FE1C351EC03C295083C0~%")
    (int->block result)))

(test-gf128mul-spec1)
(test-gf128mul-spec2)
(test-gf128mul-ghash1)
(test-gf128mul-ghash2)
(test-gf128mul-ghash3)
(test-gf128mul-ghash4)
